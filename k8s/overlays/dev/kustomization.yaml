---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dev
namePrefix: dev-
resources:
  - ../../base
  - namespace.yaml
  - http-pulsar-poller-fi-jyvaskyla-vp-secret.yaml
  - http-pulsar-poller-fi-kuopio-vp-secret.yaml
  - mqtt-pulsar-forwarder-secret.yaml
configMapGenerator:
  - name: http-pulsar-poller-fi-jyvaskyla-vp-config
    behavior: merge
    literals:
      - "HTTP_PASSWORD_PATH=/secrets/http-password"
      - "HTTP_URL=https://data.waltti.fi/jyvaskyla/api/gtfsrealtime/v1.0/feed/vehicleposition"
      - "HTTP_USERNAME_PATH=/secrets/http-username"
      - "PULSAR_TOPIC=persistent://apc-dev/source/gtfs-realtime-vp-fi-jyvaskyla"
  - name: http-pulsar-poller-fi-kuopio-vp-config
    behavior: merge
    literals:
      - "HTTP_PASSWORD_PATH=/secrets/http-password"
      - "HTTP_URL=https://opendatavilkku.mattersoft.fi/rtapi/gtfsrealtime/v1.0/feed/vehicleposition"
      - "HTTP_USERNAME_PATH=/secrets/http-username"
      - "PULSAR_TOPIC=persistent://apc-dev/source/gtfs-realtime-vp-fi-kuopio"
  - name: mqtt-pulsar-forwarder-config
    behavior: merge
    literals:
      - "MQTT_URL=mqtts://dev.mqtt.apc.lmj.fi"
      # For some reason the StreamNative certificate does not match the URI.
      - "PULSAR_TOPIC=persistent://apc-dev/source/mqtt-apc-from-vehicle"
images:
  - name: tvvlmj/http-pulsar-poller
    newTag: sha-b9190c6c3e32f8767d15ac9872ce6e6368321e4b
  - name: tvvlmj/mqtt-pulsar-forwarder
    newTag: sha-236dec28f94582e2473f8db0557152e4346388b0

# Add labeling here instead of base so that it affects also the resources in
# this kustomization.yaml.

# Add general labeling.
transformers:
  - add-label-created-by-managed-by.yaml

# Add app-specific labels, also within templates.
patches:
  # For http-pulsar-poller-fi-jyvaskyla-vp
  - patch: |-
      - op: add
        path: /metadata/labels/app.kubernetes.io~1version
        value: sha-b9190c6c3e32f8767d15ac9872ce6e6368321e4b
      - op: add
        path: /metadata/labels/app.kubernetes.io~1component
        value: http-pulsar-poller
      - op: add
        path: /metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      labelSelector: "app.kubernetes.io/instance=http-pulsar-poller-fi-jyvaskyla-vp"
  - patch: |-
      - op: add
        path: /metadata/labels/app.kubernetes.io~1version
        value: sha-b9190c6c3e32f8767d15ac9872ce6e6368321e4b
      - op: add
        path: /metadata/labels/app.kubernetes.io~1component
        value: http-pulsar-poller
      - op: add
        path: /metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/instance=http-pulsar-poller-fi-jyvaskyla-vp"

  # For http-pulsar-poller-fi-kuopio-vp
  - patch: |-
      - op: add
        path: /metadata/labels/app.kubernetes.io~1version
        value: sha-b9190c6c3e32f8767d15ac9872ce6e6368321e4b
      - op: add
        path: /metadata/labels/app.kubernetes.io~1component
        value: http-pulsar-poller
      - op: add
        path: /metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      labelSelector: "app.kubernetes.io/instance=http-pulsar-poller-fi-kuopio-vp"
  - patch: |-
      - op: add
        path: /metadata/labels/app.kubernetes.io~1version
        value: sha-b9190c6c3e32f8767d15ac9872ce6e6368321e4b
      - op: add
        path: /metadata/labels/app.kubernetes.io~1component
        value: http-pulsar-poller
      - op: add
        path: /metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/instance=http-pulsar-poller-fi-kuopio-vp"

  # For mqtt-pulsar-forwarder
  - patch: |-
      - op: add
        path: /metadata/labels/app.kubernetes.io~1instance
        value: mqtt-pulsar-forwarder
      - op: add
        path: /metadata/labels/app.kubernetes.io~1version
        value: sha-236dec28f94582e2473f8db0557152e4346388b0
      - op: add
        path: /metadata/labels/app.kubernetes.io~1component
        value: mqtt-pulsar-forwarder
      - op: add
        path: /metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      labelSelector: "app.kubernetes.io/name=mqtt-pulsar-forwarder"
  - patch: |-
      - op: add
        path: /spec/template/metadata/labels/app.kubernetes.io~1instance
        value: mqtt-pulsar-forwarder
      - op: add
        path: /spec/template/metadata/labels/app.kubernetes.io~1version
        value: sha-236dec28f94582e2473f8db0557152e4346388b0
      - op: add
        path: /spec/template/metadata/labels/app.kubernetes.io~1component
        value: mqtt-pulsar-forwarder
      - op: add
        path: /spec/template/metadata/labels/app.kubernetes.io~1part-of
        value: data-source
    target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/name=mqtt-pulsar-forwarder"
